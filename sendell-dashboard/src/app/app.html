<div class="sendell-container">
  <!-- Header -->
  <header class="sendell-header">
    <h1>SENDELL CEREBRO</h1>
    <span class="live-indicator">● LIVE</span>
  </header>

  <!-- Navigation Tabs -->
  <nav class="sendell-tabs">
    <button
      [class.active]="activeTab() === 'memorias'"
      (click)="setActiveTab('memorias')">
      MEMORIAS
    </button>
    <button
      [class.active]="activeTab() === 'prompts'"
      (click)="setActiveTab('prompts')">
      PROMPTS
    </button>
    <button
      [class.active]="activeTab() === 'herramientas'"
      (click)="setActiveTab('herramientas')">
      HERRAMIENTAS
    </button>
    <button
      [class.active]="activeTab() === 'proyectos'"
      (click)="setActiveTab('proyectos')">
      PROYECTOS
    </button>
    <button
      [class.active]="activeTab() === 'claude-terminals'"
      (click)="setActiveTab('claude-terminals')">
      CLAUDE CODE
    </button>
  </nav>

  <!-- Tab Content -->
  <main class="sendell-content">
    <!-- TAB 1: MEMORIAS -->
    @if (activeTab() === 'memorias') {
      <div class="tab-panel">
        <h2>MEMORIAS - FACTS APRENDIDOS</h2>

        <!-- Add Fact Form -->
        <div class="add-fact-form">
          <input
            type="text"
            [(ngModel)]="newFactText"
            placeholder="Nuevo fact..."
            class="cyber-input"
          />
          <select [(ngModel)]="newFactCategory" class="cyber-select">
            <option value="general">General</option>
            <option value="work">Trabajo</option>
            <option value="personal">Personal</option>
          </select>
          <button (click)="addFact()" class="cyber-button">AGREGAR</button>
        </div>

        <!-- Facts List -->
        <div class="facts-list">
          @for (fact of facts(); track $index) {
            <div class="fact-card">
              <div class="fact-category">{{ fact.category }}</div>
              <div class="fact-text">{{ fact.fact }}</div>
              <button (click)="deleteFact($index)" class="delete-button">ELIMINAR</button>
            </div>
          } @empty {
            <div class="empty-state">No hay facts todavía</div>
          }
        </div>
      </div>
    }

    <!-- TAB 2: PROMPTS -->
    @if (activeTab() === 'prompts') {
      <div class="tab-panel">
        <h2>SYSTEM PROMPT</h2>
        <textarea
          [(ngModel)]="promptText"
          class="cyber-textarea"
          rows="20"
        ></textarea>
        <button (click)="savePrompt()" class="cyber-button">GUARDAR PROMPT</button>
      </div>
    }

    <!-- TAB 3: HERRAMIENTAS -->
    @if (activeTab() === 'herramientas') {
      <div class="tab-panel">
        <h2>HERRAMIENTAS DISPONIBLES</h2>
        <div class="tools-list">
          @for (tool of tools(); track $index) {
            <div class="tool-card">
              <div class="tool-name">{{ tool.name }}</div>
              <div class="tool-desc">{{ tool.description }}</div>
            </div>
          } @empty {
            <div class="empty-state">Cargando herramientas...</div>
          }
        </div>
      </div>
    }

    <!-- TAB 4: PROYECTOS -->
    @if (activeTab() === 'proyectos') {
      <div class="tab-panel proyectos-layout">
        <div class="proyectos-header">
          <h2>PROYECTOS ACTIVOS</h2>
          <div class="clock">{{ currentTime() }}</div>
        </div>

        <!-- Metrics Panel -->
        <div class="metrics-panel">
          <div class="metric-card">
            <div class="metric-label">CPU TOTAL</div>
            <div class="metric-value">{{ metrics().cpu.toFixed(1) }}%</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">MEMORIA</div>
            <div class="metric-value">{{ metrics().ram.toFixed(1) }}%</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">TERMINALES</div>
            <div class="metric-value">{{ metrics().terminals }}</div>
          </div>
        </div>

        <!-- Projects List -->
        <div class="projects-list">
          @for (project of projects(); track project.pid) {
            <div class="project-card"
                 [class.working]="project.state === 'working'"
                 [class.ready]="project.state === 'ready'"
                 [class.offline]="project.state === 'offline'"
                 [class.clickable]="project.state === 'offline' || project.state === 'ready'"
                 [class.loading]="loadingProjectPid() === project.pid"
                 (click)="onProjectClick(project)">

              <!-- Loading Overlay -->
              @if (loadingProjectPid() === project.pid) {
                <div class="loading-overlay">
                  <div class="loading-spinner-project"></div>
                  <div class="loading-text-project">Opening terminal...</div>
                </div>
              }

              <div class="project-header">
                <div class="project-name"
                     [class.working-name]="project.state === 'working'"
                     [class.ready-name]="project.state === 'ready'">
                  [{{ $index + 1 }}] {{ project.name }}
                </div>
                <div class="project-status"
                     [class.status-working]="project.state === 'working'"
                     [class.status-ready]="project.state === 'ready'"
                     [class.status-offline]="project.state === 'offline'">
                  [{{ project.state?.toUpperCase() ?? 'UNKNOWN' }}]
                  @if (project.bridge_status) {
                    <span class="bridge-indicator">{{ project.bridge_status }}</span>
                  }
                </div>
              </div>

              <!-- Activity Graph -->
              <div class="activity-graph-container">
                <activity-graph [status]="project.state"></activity-graph>
              </div>

              <div class="project-info">
                <div>Path: {{ project.workspace_path }}</div>
                <div>PID: {{ project.pid }}</div>
                @if (project.has_terminal) {
                  <div>✓ Terminal abierto</div>
                }
                @if (project.state === 'offline' || project.state === 'ready') {
                  <div class="click-hint">
                    @if (project.state === 'offline') {
                      Click para abrir terminal
                    } @else {
                      Click para abrir nueva terminal
                    }
                  </div>
                }
              </div>
            </div>

          } @empty {
            <div class="empty-state">
              No hay proyectos VS Code activos<br>
              Abre un proyecto en VS Code para verlo aquí
            </div>
          }
        </div>
      </div>
    }

    <!-- TAB 5: CLAUDE CODE TERMINALS -->
    @if (activeTab() === 'claude-terminals') {
      <div class="tab-panel">
        <div class="proyectos-header">
          <h2>CLAUDE CODE TERMINALS</h2>
          <button (click)="refreshClaudeTerminals()" class="cyber-button">
            REFRESH
          </button>
        </div>

        <!-- Loading State -->
        @if (claudeService.isLoading()) {
          <div class="loading-container">
            <div class="loading-spinner"></div>
            <p class="loading-text">
              Detecting Claude Code processes...<br>
              This may take 16-20 seconds
            </p>
          </div>
        }

        <!-- Error State -->
        @if (claudeService.error()) {
          <div class="error-panel">
            <p>{{ claudeService.error() }}</p>
            <button (click)="claudeService.clearError()" class="cyber-button">
              DISMISS
            </button>
          </div>
        }

        <!-- Terminals List -->
        @if (!claudeService.isLoading() && !claudeService.error()) {
          <div class="terminals-section">
            <h3>DETECTED TERMINALS ({{ claudeService.terminals().length }})</h3>
            @if (claudeService.lastUpdate()) {
              <p class="last-update">
                Last update: {{ claudeService.lastUpdate() }}
              </p>
            }

            <div class="terminals-list">
              @for (terminal of claudeService.terminals(); track terminal.pid) {
                <div class="terminal-card"
                     [class.active]="terminal.is_active"
                     [class.idle]="!terminal.is_active">
                  <div class="terminal-header">
                    <span class="terminal-status"
                          [class.status-running]="terminal.is_active"
                          [class.status-idle]="!terminal.is_active">
                      [{{ terminal.status.toUpperCase() }}]
                    </span>
                    <span class="terminal-pid">PID: {{ terminal.pid }}</span>
                  </div>

                  <div class="terminal-info">
                    <div><strong>Name:</strong> {{ terminal.name }}</div>
                    <div><strong>Working Dir:</strong> {{ terminal.cwd }}</div>
                    <div><strong>CPU:</strong> {{ terminal.cpu_percent }}%</div>
                    <div><strong>Memory:</strong> {{ terminal.memory_mb }} MB</div>
                  </div>

                  <div class="terminal-cmdline">
                    <strong>Command:</strong>
                    <code>{{ terminal.cmdline.substring(0, 100) }}...</code>
                  </div>
                </div>
              } @empty {
                <div class="empty-state">
                  No Claude Code terminals detected<br>
                  Open a Claude Code terminal and click REFRESH
                </div>
              }
            </div>
          </div>

          <!-- Sessions List -->
          <div class="sessions-section">
            <h3>ACTIVE SESSIONS ({{ claudeService.sessions().length }})</h3>
            <div class="sessions-list">
              @for (session of claudeService.sessions(); track session.session_id) {
                <div class="session-card">
                  <div class="session-header">
                    <span class="session-project">{{ session.project }}</span>
                    <span class="session-state"
                          [class.state-idle]="session.state === 'idle'"
                          [class.state-running]="session.state === 'generating' || session.state === 'executing_tool'"
                          [class.state-error]="session.state === 'error'">
                      [{{ session.state.toUpperCase() }}]
                    </span>
                  </div>

                  <div class="session-info">
                    <div><strong>Events:</strong> {{ session.event_count }}</div>
                    @if (session.token_usage) {
                      <div><strong>Tokens:</strong> {{ session.token_usage.total }}</div>
                    }
                    @if (session.seconds_since_last_event !== undefined) {
                      <div><strong>Last activity:</strong> {{ session.seconds_since_last_event }}s ago</div>
                    }
                  </div>
                </div>
              } @empty {
                <div class="empty-state">
                  No active sessions found
                </div>
              }
            </div>
          </div>
        }
      </div>
    }
  </main>
</div>

<!-- TERMINAL MODAL (renders outside main layout, fixed position) -->
@if (terminalService.currentTerminalPid()) {
  <app-terminal
    [projectPid]="terminalService.currentTerminalPid()!"
    [workspacePath]="getCurrentProject()?.workspace_path || ''"
    [projectName]="getCurrentProject()?.name || 'Terminal'"
    (close)="terminalService.closeTerminal()"
  />
}
